<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Cài đặt</title>
    <!-- Nạp CSS theo đúng thứ tự ưu tiên -->
    <link rel="stylesheet" href="css/shared-layout.css"> <!-- Cấp 1: Dùng chung -->
    <link rel="stylesheet" href="css/toast.css"> <!-- Cấp 1: Dùng chung -->
    <link rel="stylesheet" href="css/manager-layout.css"> <!-- Cấp 2: Layout vai trò -->
    <!-- Nạp Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Nạp CSS riêng cho trang này -->
    <link rel="stylesheet" href="css/manager-setting.css">
    <link rel="icon" href="images/magnetic.png" type="image/png">
</head>
<body>
    <div class="manager-layout">
        <!-- Sidebar Menu (Copy từ manager.html) -->
        <nav class="sidebar">
            <ul class="menu-links">
                <li><a href="manager-main.html" class="nav-link"><i class="fas fa-home"></i><span>Main</span></a></li>
                <li><a href="manager-setting.html" class="nav-link active"><i class="fas fa-calendar-alt"></i><span>Quản lý thông tin năm học</span></a></li>
                <li><a href="manager-syllabus.html" class="nav-link"><i class="fas fa-book-open"></i><span>Phân phối chương trình</span></a></li>
                <li><a href="manager-device.html" class="nav-link"><i class="fas fa-desktop"></i><span>Danh mục thiết bị</span></a></li>
                <li><a href="manager-synthetic.html" class="nav-link"><i class="fas fa-chart-pie"></i><span>Tổng hợp</span></a></li>
                <li><a href="manager-report.html" class="nav-link"><i class="fas fa-file-alt"></i><span>Báo cáo</span></a></li>
            </ul>
        </nav>

        <!-- Main Content Wrapper (Copy từ manager.html) -->
        <div class="content-wrapper">
            <div class="top-bar">
                <h1 id="page-title">Quản lý thông tin năm học</h1>
                <!-- Nút menu toggle sẽ được JS tự động thêm vào trên mobile -->
                <div class="top-bar-actions">
                    <div class="user-info">
                        <span>Chào, <span id="user-name">Manager</span>!</span>
                        <button id="edit-profile-button" class="icon-button" title="Chỉnh sửa thông tin">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </div>
                    <button id="logout-button" class="logout-button">Đăng xuất</button>
                </div>
            </div>
            <main id="main-content" class="main-content">
                <!-- Nội dung chính của trang cài đặt -->
                <div class="content-card" id="setting-management-content">
                    <div class="school-year-selector-header">
                        <div class="selector-container">
                            <select id="school-year-select"></select>
                            <button id="add-school-year-btn" class="btn-secondary"><i class="fas fa-plus"></i> Năm học mới</button>
                        </div>
                    </div>

                    <div class="tab-nav">
                        <button class="tab-link active" data-tab="groups-teachers"><i class="fas fa-users"></i><span class="desktop-text">Tổ chuyên môn & Giáo viên</span><span class="mobile-text">Tổ & GV</span></button>
                        <button class="tab-link" data-tab="teaching-methods"><i class="fas fa-lightbulb"></i><span class="desktop-text">Phương pháp dạy học</span><span class="mobile-text">PPDH</span></button>
                        <button class="tab-link" data-tab="data-repair"><i class="fas fa-tools"></i><span class="desktop-text">Sửa lỗi dữ liệu</span><span class="mobile-text">Sửa lỗi</span></button>
                        <button class="tab-link" data-tab="time-plan"><i class="fas fa-calendar-alt"></i><span class="desktop-text">Kế hoạch thời gian</span><span class="mobile-text">Kế hoạch</span></button>
                        <button class="tab-link" data-tab="registration-rules"><i class="fas fa-gavel"></i><span class="desktop-text">Quy tắc Đăng ký</span><span class="mobile-text">Quy tắc</span></button>
                        <button class="tab-link" data-tab="class-timings"><i class="fas fa-clock"></i><span class="desktop-text">Thời gian tiết học</span><span class="mobile-text">Tiết học</span></button>
                    </div>

                    <div id="tab-content-container">
                        <div id="groups-teachers" class="tab-content active">
                            <div class="page-header">
                                <h2>Danh sách Tổ chuyên môn & Giáo viên</h2>
                                <button id="add-group-btn" class="btn-primary"><i class="fas fa-plus"></i> Thêm Tổ</button>
                            </div>
                            <div id="groups-container"><p>Vui lòng chọn một năm học để xem dữ liệu.</p></div>
                        </div>
                        <div id="teaching-methods" class="tab-content">
                            <div class="page-header">
                                <h2>Phương pháp dạy học</h2>
                                <button id="add-method-btn" class="btn-primary"><i class="fas fa-plus"></i> Thêm Phương pháp</button>
                            </div>
                            <div id="methods-container"><p>Vui lòng chọn một năm học để xem dữ liệu.</p></div>
                        </div>

                        <!-- Tab Sửa lỗi dữ liệu -->
                        <div id="data-repair" class="tab-content">
                            <!-- Card cho chức năng chạy tất cả -->
                            <div class="repair-section-card all-repairs-card">
                                <div class="content-header">
                                    <h2>Tự động sửa lỗi hàng loạt</h2>
                                    <button id="run-all-repairs-btn" class="btn-danger"><i class="fas fa-magic"></i> Chạy tất cả chức năng sửa lỗi</button>
                                </div>
                                <div class="instruction-text">
                                    <p><i class="fas fa-info-circle"></i> Chức năng này sẽ tự động chạy tuần tự cả 3 công cụ sửa lỗi bên dưới. Tiến trình sẽ được hiển thị ở đây.</p>
                                </div>
                                <div id="all-repairs-status-container">
                                    <!-- Trạng thái chạy tất cả sẽ hiển thị ở đây -->
                                </div>
                            </div>

                            <!-- Card cho chức năng sửa Teacher ID -->
                            <div class="repair-section-card">
                                <div class="content-header">
                                    <h2>Sửa lỗi Teacher ID (Tài khoản bị xóa)</h2>
                                    <button id="find-orphaned-regs-btn" class="btn-primary"><i class="fas fa-user-slash"></i> Quét ID giáo viên mồ côi</button>
                                </div>
                                <div class="instruction-text">
                                    <p><i class="fas fa-info-circle"></i> Chức năng này sẽ quét toàn bộ các lượt đăng ký để tìm những đăng ký có `teacherId` không còn tồn tại trong danh sách giáo viên hiện tại (do tài khoản giáo viên đã bị xóa và tạo lại).</p>
                                    <p>Sau khi quét, bạn có thể chọn giáo viên mới để gán lại cho các lượt đăng ký bị "mồ côi" này.</p>
                                </div>
                                <div id="data-repair-results-container">
                                    <!-- Kết quả quét sẽ được hiển thị ở đây -->
                                </div>
                            </div>

                            <!-- Card cho chức năng sửa Môn học -->
                            <div class="repair-section-card">
                                <div class="content-header">
                                    <h2>Sửa lỗi sai môn học</h2>
                                    <button id="find-subject-mismatch-btn" class="btn-primary"><i class="fas fa-book"></i> Quét môn học không khớp</button>
                                </div>
                                <div class="instruction-text">
                                    <p><i class="fas fa-info-circle"></i> Chức năng này sẽ tìm các lượt đăng ký có môn học không khớp với môn học chính của giáo viên. Bạn có thể tự động sửa tất cả các lỗi này về đúng môn học đã được phân công.</p>
                                    <p><strong>Ngoại lệ:</strong> GV môn <strong>Sinh học</strong> được phép dạy <strong>Công nghệ nông nghiệp</strong>. GV môn <strong>Vật lí</strong> được phép dạy <strong>Công nghệ công nghiệp</strong>.</p>
                                </div>
                                <div id="subject-repair-results-container">
                                    <!-- Kết quả quét lỗi môn học sẽ hiển thị ở đây -->
                                </div>
                            </div>

                            <!-- Card cho chức năng sửa Group ID -->
                            <div class="repair-section-card">
                                <div class="content-header">
                                    <h2>Sửa lỗi thiếu ID Tổ chuyên môn</h2>
                                    <button id="find-missing-groupid-btn" class="btn-primary"><i class="fas fa-sitemap"></i> Quét đăng ký thiếu ID Tổ</button>
                                </div>
                                <div class="instruction-text">
                                    <p><i class="fas fa-info-circle"></i> Chức năng này sẽ tìm các lượt đăng ký không được lưu `groupId` (thường là dữ liệu cũ). Việc thiếu `groupId` có thể khiến báo cáo hiển thị sai tổ chuyên môn nếu giáo viên đã chuyển tổ.</p>
                                    <p>Sau khi quét, bạn có thể tự động cập nhật `groupId` chính xác cho các lượt đăng ký này dựa trên thông tin tổ của giáo viên tại thời điểm quét.</p>
                                </div>
                                <div id="groupid-repair-results-container">
                                    <!-- Kết quả quét lỗi groupId sẽ hiển thị ở đây -->
                                </div>
                            </div>
                        </div>

                        <div id="time-plan" class="tab-content">
                            <div class="page-header">
                                <h2>Kế hoạch thời gian năm học</h2>
                            </div>
                            <div id="time-plan-setup" class="time-plan-setup-card">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="school-year-start-date">Ngày bắt đầu năm học (Thứ 2)</label>
                                        <input type="date" id="school-year-start-date">
                                    </div>
                                    <div class="form-group">
                                        <label for="report-day-input">Ngày chốt báo cáo tháng</label>
                                        <input type="number" id="report-day-input" value="23" min="1" max="28">
                                    </div>
                                    <div class="form-group">
                                        <label for="semester-end-week-input">Tuần kết thúc Học kỳ I</label>
                                        <input type="number" id="semester-end-week-input" value="19" min="1" max="36">
                                    </div>
                                </div>
                                <button id="generate-plan-btn" class="btn-primary"><i class="fas fa-cogs"></i> Tạo / Cập nhật Kế hoạch</button>
                                <p class="form-note">Chọn ngày bắt đầu là thứ Hai của tuần đầu tiên. Hệ thống sẽ tự động tạo kế hoạch cho 37 tuần học. Nếu kế hoạch đã tồn tại, nó sẽ được tải.</p>
                            </div>
                            <div id="weekly-plan-container"></div>
                        </div>

                        <!-- Tab Quy tắc Đăng ký -->
                        <div id="registration-rules" class="tab-content">
                            <div class="page-header">
                                <h2>Thiết lập Quy tắc Đăng ký cho Giáo viên</h2>
                            </div>
                            <div class="instruction-text">
                                <p><i class="fas fa-info-circle"></i> Chọn một quy tắc để giới hạn thời gian giáo viên có thể đăng ký hoặc chỉnh sửa tiết dạy. Quy tắc này sẽ được áp dụng cho toàn bộ năm học hiện tại.</p>
                            </div>
                            <div id="rules-container" class="rules-container">
                                <!-- Các tùy chọn quy tắc sẽ được JS chèn vào đây -->
                                <p><i class="fas fa-spinner fa-spin"></i> Đang tải quy tắc...</p>
                            </div>
                            <div class="modal-actions" style="justify-content: flex-end; margin-top: 20px;">
                                <button id="save-rules-btn" class="btn-save"><i class="fas fa-save"></i> Lưu Quy tắc</button>
                            </div>
                        </div>

                        <!-- Tab Thời gian tiết học -->
                        <div id="class-timings" class="tab-content">
                            <div class="page-header">
                                <h2>Thiết lập Thời gian tiết học</h2>
                                <div class="active-season-status">
                                    Trạng thái áp dụng: <span id="active-season-display" class="status-badge">Đang tải...</span>
                                </div>
                            </div>
                            <div class="instruction-text">
                                <p><i class="fas fa-info-circle"></i> Thiết lập các thông số chung, hệ thống sẽ tự động tính toán lịch trình chi tiết. Nhấn "Xem trước" để kiểm tra kết quả trước khi lưu.</p>
                            </div>

                            <!-- Vùng cấu hình -->
                            <div class="timings-config-grid">
                                <!-- Cấu hình chung -->
                                <div class="config-card">
                                    <h4><i class="fas fa-cogs"></i> Cấu hình chung</h4>
                                    <div class="form-group">
                                        <label for="period-duration">Thời gian mỗi tiết (phút)</label>
                                        <input type="number" id="period-duration" value="45">
                                    </div>
                                    <div class="form-group">
                                        <label for="short-break-duration">Giải lao ngắn (phút)</label>
                                        <input type="number" id="short-break-duration" value="5">
                                    </div>
                                    <div class="form-group">
                                        <label for="long-break-duration">Giải lao giữa buổi (phút)</label>
                                        <input type="number" id="long-break-duration" value="15">
                                    </div>
                                </div>
                                <!-- Cấu hình Mùa hè -->
                                <div class="config-card">
                                    <h4><i class="fas fa-sun"></i> Mùa hè</h4>
                                    <div class="form-group">
                                        <label for="summer-morning-start">Bắt đầu tiết 1 (Sáng)</label>
                                        <input type="time" id="summer-morning-start" value="07:00">
                                    </div>
                                    <div class="form-group">
                                        <label for="summer-afternoon-start">Bắt đầu tiết 1 (Chiều)</label>
                                        <input type="time" id="summer-afternoon-start" value="13:00">
                                    </div>
                                    <button id="apply-summer-btn" class="btn-apply-season" title="Lưu cấu hình và áp dụng lịch mùa hè cho toàn hệ thống"><i class="fas fa-sun"></i> Áp dụng thời gian học mùa hè</button>
                                </div>
                                <!-- Cấu hình Mùa đông -->
                                <div class="config-card">
                                    <h4><i class="fas fa-snowflake"></i> Mùa đông</h4>
                                    <div class="form-group">
                                        <label for="winter-morning-start">Bắt đầu tiết 1 (Sáng)</label>
                                        <input type="time" id="winter-morning-start" value="07:00">
                                    </div>
                                    <div class="form-group">
                                        <label for="winter-afternoon-start">Bắt đầu tiết 1 (Chiều)</label>
                                        <input type="time" id="winter-afternoon-start" value="12:45">
                                    </div>
                                    <button id="apply-winter-btn" class="btn-apply-season" title="Lưu cấu hình và áp dụng lịch mùa đông cho toàn hệ thống"><i class="fas fa-snowflake"></i> Áp dụng thời gian học mùa đông</button>
                                </div>
                            </div>

                            <!-- Vùng xem trước -->
                            <div id="timings-preview-container" class="timings-container">
                                <div class="timing-season-card">
                                    <h3 id="active-schedule-title"><i class="fas fa-clock"></i> Khung thời gian áp dụng hiện tại</h3>
                                    <div id="active-schedule-container">
                                        <!-- Khung thời gian của mùa đang áp dụng sẽ được hiển thị ở đây -->
                                        <p>Đang tải khung thời gian...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal cho Tổ chuyên môn -->
    <div id="group-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="group-modal-title">Thêm Tổ chuyên môn</h2>
            <div class="form-group">
                <label for="group-name-input">Tên tổ</label>
                <input type="text" id="group-name-input" placeholder="Ví dụ: Tổ Toán - Tin">
            </div>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-group-modal" class="btn-cancel">Hủy</button>
                    <button id="save-group-btn" class="btn-save">
                        <span class="btn-text">Lưu</span>
                        <span class="btn-spinner"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal cho Phương pháp dạy học -->
    <div id="method-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="method-modal-title">Thêm Phương pháp dạy học</h2>
            <div class="form-group">
                <label for="method-name-input">Tên phương pháp</p>
                <input type="text" id="method-name-input" placeholder="Ví dụ: Dạy học theo dự án">
            </div>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-method-modal" class="btn-cancel">Hủy</button>
                    <button id="save-method-btn" class="btn-save">
                        <span class="btn-text">Lưu</span>
                        <span class="btn-spinner"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal cho Năm học -->
    <div id="school-year-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Thêm năm học mới</h2>
            <div class="form-group">
                <label for="school-year-name-input">Tên năm học</label>
                <input type="text" id="school-year-name-input" placeholder="Ví dụ: 2024-2025">
            </div>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-school-year-modal" class="btn-cancel">Hủy</button>
                    <button id="save-school-year-btn" class="btn-save">
                        <span class="btn-text">Lưu</span>
                        <span class="btn-spinner"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal cho Giáo viên -->
    <div id="teacher-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <form id="teacher-form">
                <h2 id="teacher-modal-title">Thêm Giáo viên</h2>
                <div class="form-group">
                    <label for="teacher-names-input">Tên giáo viên</label>
                    <textarea id="teacher-names-input" placeholder="Nhập mỗi giáo viên trên một dòng..." rows="5"></textarea>
                </div>
                <div class="form-group" id="teacher-subject-group" style="display: none;">
                    <label for="teacher-subject-input">Môn học chính</label>
                    <select id="teacher-subject-input"></select>
                    <p class="form-note">Chỉ cần chọn khi giáo viên thuộc tổ chuyên môn ghép.</p>
                </div>
                <div class="form-group" style="display: none;">
                    <label for="teacher-phone-input">Số điện thoại</label>
                    <input type="tel" id="teacher-phone-input" placeholder="Nhập số điện thoại (không bắt buộc)">
                </div>
            </form>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-teacher-modal" class="btn-cancel">Hủy</button>
                    <button id="save-teacher-btn" class="btn-save">
                        <span class="btn-text">Lưu</span>
                        <span class="btn-spinner"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal cho Chỉnh sửa Tuần -->
    <div id="week-edit-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="week-edit-modal-title">Chỉnh sửa Tuần <span id="week-edit-number"></span></h2>
            <div class="form-group">
                <label for="week-start-date-input">Ngày bắt đầu</label>
                <input type="date" id="week-start-date-input" class="form-control">
            </div>
            <div class="form-group">
                <label for="week-end-date-input">Ngày kết thúc</label>
                <input type="date" id="week-end-date-input" class="form-control">
            </div>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-week-edit-modal" class="btn-cancel">Hủy</button>
                    <button id="save-week-btn" class="btn-save">
                        <span class="btn-text">Lưu</span>
                        <span class="btn-spinner"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal xác nhận xóa -->
    <div id="confirm-delete-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="confirm-delete-message">Xác nhận xóa</h2>
            <p id="confirm-delete-message">Bạn có chắc chắn muốn xóa mục này không? Hành động này không thể hoàn tác.</p>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-delete-btn" class="btn-cancel">Hủy</button>
                    <button id="confirm-delete-btn" class="btn-danger">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- Modal chỉnh sửa thông tin (Copy từ manager.html) -->
    <!-- Bạn cũng cần copy modal 'profile-modal' từ file manager.html vào đây nếu muốn chức năng "Chỉnh sửa thông tin" hoạt động trên trang này -->

    <!-- Nạp các script cần thiết -->
        <!-- Thêm thư viện SortableJS cho chức năng kéo-thả -->
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
        <script type="module" src="js/auth-guard.js"></script>
        <script type="module" src="js/manager-nav.js"></script>
        <script type="module" src="js/toast.js"></script>
        <script type="module" src="js/manager-setting.js"></script>
</body>
</html>