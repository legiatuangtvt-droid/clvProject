<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Danh mục thiết bị</title>
    <link rel="stylesheet" href="css/shared-layout.css">
    <link rel="stylesheet" href="css/manager-device.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="icon" href="images/magnetic.png" type="image/png">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar Menu -->
        <nav class="sidebar">
            <ul class="menu-links">
                <li><a href="manager-main.html" class="nav-link"><i class="fas fa-home"></i><span>Main</span></a></li>
                <li><a href="manager-setting.html" class="nav-link"><i class="fas fa-calendar-alt"></i><span>Quản lý thông tin năm học</span></a></li>
                <li><a href="manager-syllabus.html" class="nav-link"><i class="fas fa-book-open"></i><span>Phân phối chương trình</span></a></li>
                <li><a href="manager-device.html" class="nav-link active"><i class="fas fa-desktop"></i><span>Danh mục thiết bị</span></a></li>
                <li><a href="manager-labs.html" class="nav-link"><i class="fas fa-flask"></i><span>Phòng học bộ môn</span></a></li>
                <li><a href="manager-synthetic.html" class="nav-link"><i class="fas fa-chart-pie"></i><span>Tổng hợp</span></a></li>
                <li><a href="manager-report.html" class="nav-link"><i class="fas fa-file-alt"></i><span>Báo cáo</span></a></li>
                <li><a href="manager-tracking.html" class="nav-link"><i class="fas fa-chart-line"></i><span>Theo dõi & Tổng hợp</span></a></li>
            </ul>
        </nav>

        <!-- Main Content Wrapper -->
        <div class="content-wrapper">
            <div class="top-bar">
                <h1 id="page-title">Danh mục thiết bị</h1>
                <div class="top-bar-actions">
                    <div class="user-info">
                        <span>Chào, <span id="user-name">Manager</span>!</span>
                        <button id="edit-profile-button" class="icon-button" title="Chỉnh sửa thông tin">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button id="logout-button" class="logout-button">Đăng xuất</button>
                    </div>
                </div>
            </div>
            <main id="main-content" class="main-content">
                <!-- Nội dung chính của trang device -->
                <div class="content-card">
                    <div id="device-explorer-layout" class="device-explorer-layout-flat">
                        <!-- Nội dung chính: Bảng danh mục -->
                        <div id="device-content-main" class="device-content-main-full">
                            <div class="page-header">
                                <div id="breadcrumb-container">
                                    <!-- Breadcrumbs sẽ được JS render vào đây -->
                                </div>
                                <div class="page-actions">
                                    <button id="add-category-btn" class="btn-secondary"><i class="fas fa-folder-plus"></i> Thêm Danh mục</button>
                                    <button id="bulk-import-btn" class="btn-primary" disabled><i class="fas fa-file-import"></i> Nhập hàng loạt</button>
                                    <button id="add-device-btn" class="btn-primary" disabled><i class="fas fa-plus"></i> Thêm Thiết bị</button>
                                    <button id="export-inventory-btn" class="btn-secondary"><i class="fas fa-file-word"></i> Xuất biên bản kiểm kê</button>
                                </div>
                            </div>
                            <div id="device-list-container" class="table-container">
                                <!-- Bảng danh sách thiết bị và thư mục con sẽ được JS render vào đây -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal cho Thêm/Sửa DANH MỤC -->
    <div id="category-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="category-modal-title">Thêm Danh mục</h2>
            <form id="category-form" class="form-grid">
                <div class="form-group form-group-span-2">
                    <label for="category-name">Tên Danh mục <span class="required-star">*</span></label>
                    <input type="text" id="category-name" required>
                </div>
                <div class="form-group">
                    <label for="category-order">Thứ tự</label>
                    <input type="text" id="category-order" placeholder="A, B, I, II, 1, 2...">
                </div>
                <div class="form-group" id="category-parent-select-group">
                    <label for="category-parent-select">Vị trí (Danh mục cha)</label>
                    <select id="category-parent-select" class="form-control"></select>
                </div>
                <div class="form-group form-group-span-2" id="category-subject-select-group" style="display: none;">
                    <label for="category-subject-search-input">Môn học tương ứng</label>
                    <div id="category-subjects-select-wrapper" class="custom-select-wrapper">
                        <div id="category-subjects-container" class="custom-select-container">
                            <!-- Các thẻ môn học đã chọn sẽ được chèn vào đây -->
                            <input type="text" id="category-subject-search-input" placeholder="Tìm và chọn môn học...">
                        </div>
                        <div id="category-subject-dropdown" class="subject-dropdown-list" style="display: none;"></div>
                    </div>
                    <p class="form-note">Chỉ áp dụng cho danh mục cấp cao nhất. Có thể chọn nhiều môn học.</p>
                </div>
            </form>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-category-modal" class="btn-cancel">Hủy</button>
                    <button id="save-category-btn" class="btn-save"><span class="btn-text">Lưu</span><span class="btn-spinner"></span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal cho Thêm/Sửa THIẾT BỊ -->
    <div id="device-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="device-modal-title">Thêm Thiết bị</h2>
            <form id="device-form" class="device-form-grid">
                <div class="form-group form-group-span-2">
                    <div class="filter-group">
                        <label for="device-name">Tên Thiết bị <span class="required-star">*</span></label>
                        <input type="text" id="device-name" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <div class="filter-group">
                        <label for="device-order">Thứ tự</label>
                        <input type="text" id="device-order" class="form-control" placeholder="A, B, I, II, 1, 2...">
                    </div>
                </div>
                <div class="form-group">
                    <div class="filter-group">
                        <label for="device-parent-select">Vị trí</label>
                        <select id="device-parent-select" class="filter-select"></select>
                    </div>
                </div>
                <div class="form-group">
                    <div class="filter-group">
                        <label for="device-topic">Chủ đề</label>
                        <input type="text" id="device-topic" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <div class="filter-group">
                        <label for="device-purpose">Mục đích</label>
                        <input type="text" id="device-purpose" class="form-control">
                    </div>
                </div>
                <div class="form-group form-group-span-2">
                    <div class="filter-group textarea-group">
                        <label for="device-description">Mô tả</label>
                        <textarea id="device-description" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="form-group checkbox-group-container">
                    <label>Đối tượng sử dụng</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" id="device-usage-gv"> Giáo viên</label>
                        <label class="checkbox-item"><input type="checkbox" id="device-usage-hs"> Học sinh</label>
                    </div>
                </div>
                <div class="form-group"><div class="filter-group"><label for="device-unit">ĐVT</label><input type="text" id="device-unit" class="form-control"></div></div>
                <div class="form-group"><div class="filter-group"><label for="device-quota">Định mức</label><input type="text" id="device-quota" class="form-control"></div></div>
                <div class="form-group"><div class="filter-group"><label for="device-quantity">Tổng số</label><input type="number" id="device-quantity" class="form-control" value="0"></div></div>
                <div class="form-group"><div class="filter-group"><label for="device-broken">Hỏng</label><input type="number" id="device-broken" class="form-control" value="0"></div></div>
            </form>
            <!-- NEW: Thêm trường tải tệp và hiển thị liên kết -->
            <div class="form-group form-group-span-2" style="margin-top: 10px;">
                <label for="device-manual-file">Tài liệu hướng dẫn (PDF)</label>
                <input type="file" id="device-manual-file" accept=".pdf" class="form-control">
                <a href="#" id="device-manual-link" target="_blank" style="display: none; margin-top: 8px; font-style: italic;"></a>
            </div>

            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-device-modal" class="btn-cancel">Hủy</button>
                    <button id="save-device-btn" class="btn-save"><span class="btn-text">Lưu</span><span class="btn-spinner"></span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Bulk Import -->
    <div id="bulk-import-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content large">
            <h2 id="bulk-import-modal-title">Nhập dữ liệu hàng loạt</h2>
            <div class="instruction-text">
                <p><i class="fas fa-info-circle"></i> Dán dữ liệu từ file Excel vào ô bên dưới. Đảm bảo các cột theo đúng thứ tự: <strong>Số TT, Chủ đề, Tên thiết bị, Mục đích, Mô tả, Dùng cho GV, Dùng cho HS, Đơn vị, Định mức, Tổng số, Hỏng</strong>. Hai cột cuối (Tổng số, Hỏng) có thể bỏ trống và sẽ được gán giá trị là 0.</p>
                <p><strong>Lưu ý:</strong> Dữ liệu sẽ được thêm vào danh mục đang được chọn: <strong id="bulk-import-parent-name">Vui lòng chọn một danh mục</strong>.</p>
            </div>
            <div class="form-group">
                <label for="bulk-data-input">Dữ liệu từ Excel</label>
                <textarea id="bulk-data-input" class="form-control" rows="10" placeholder="Ví dụ:&#10;9&#x9;&#x9;Lò xo&#x9;Tạo lực đàn hồi&#x9;...&#x9;x&#x9;x&#x9;Cái&#x9;07"></textarea>
            </div>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-bulk-import-btn" class="btn-cancel">Hủy</button>
                    <button id="process-bulk-import-btn" class="btn-save">Xử lý và Xem trước</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Bulk Import Preview -->
    <div id="bulk-import-preview-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content large">
            <h2 id="bulk-import-preview-title">Xem trước dữ liệu nhập hàng loạt</h2>
            <div class="instruction-text">
                <p><i class="fas fa-info-circle"></i> Kiểm tra dữ liệu đã được phân tích dưới đây. Các dòng hợp lệ sẽ được thêm vào cơ sở dữ liệu. Các dòng có lỗi sẽ bị bỏ qua.</p>
            </div>
            <div id="bulk-import-error-section" style="display: none;">
                <!-- Lỗi sẽ được hiển thị ở đây -->
            </div>
            <div id="bulk-import-preview-container" class="table-container">
                <!-- Bảng xem trước sẽ được hiển thị ở đây -->
            </div>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-bulk-import-preview-btn" class="btn-cancel">Quay lại</button>
                    <button id="confirm-bulk-import-btn" class="btn-save"><span class="btn-text">Xác nhận và Nhập</span><span class="btn-spinner"></span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xác nhận xóa -->
    <div id="confirm-delete-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Xác nhận xóa</h2>
            <p id="confirm-delete-message">Bạn có chắc chắn muốn xóa mục này? Nếu đây là danh mục cha, tất cả các mục con cũng sẽ bị xóa.</p>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-delete-btn" class="btn-cancel">Hủy</button>
                    <button id="confirm-delete-btn" class="btn-danger">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xem trước biên bản kiểm kê -->
    <div id="inventory-preview-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content inventory-preview-modal-content">
            <h2><i class="fas fa-file-word"></i> Xem trước biên bản kiểm kê</h2>
            <div id="inventory-preview-container" class="inventory-preview-container">
                <!-- Nội dung biên bản HTML sẽ được JS render vào đây -->
            </div>
            <div class="modal-actions">
                <div class="modal-actions-left">
                    <button id="fill-sample-btn" class="btn-secondary"><i class="fas fa-fill-drip"></i> Điền mẫu</button>
                    <button id="clear-fields-btn" class="btn-cancel"><i class="fas fa-eraser"></i> Xóa tất cả</button>
                </div>
                <div class="modal-actions-right">
                    <button id="cancel-inventory-preview-btn" class="btn-cancel">Đóng</button>
                    <button id="download-word-btn" class="btn-primary"><i class="fas fa-download"></i> Tải file Word</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- Modal hiển thị mã QR cho thiết bị -->
    <div id="qr-code-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="qr-modal-title">Mã QR tra cứu thiết bị</h2>
            <div id="qr-code-content" style="text-align: center; padding: 20px;">
                <div id="qr-code-container"></div>
                <h3 id="qr-device-name" style="margin-top: 15px;"></h3>
                <p id="qr-device-id" style="font-size: 0.9rem; color: #6c757d;"></p>
            </div>
            <div class="modal-actions">
                <div class="modal-actions-right">
                    <button id="cancel-qr-modal" class="btn-cancel">Đóng</button>
                    <button id="download-qr-btn" class="btn-secondary">
                        <i class="fas fa-download"></i> Tải mã
                    </button>
                    <button id="view-info-qr-btn" class="btn-secondary">
                        <i class="fas fa-eye"></i> Xem thông tin
                    </button>
                    <button id="print-qr-btn" class="btn-primary">
                        <i class="fas fa-print"></i> In mã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nạp các script cần thiết -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script type="module" src="js/auth-guard.js"></script>
    <script type="module" src="js/manager-nav.js"></script>
    <script type="module" src="js/toast.js"></script>
    <script type="module" src="js/manager-device.js"></script>
</body>
</html>