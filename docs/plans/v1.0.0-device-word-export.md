# Plan v1.0.0: Xuất biên bản kiểm kê thiết bị dạy học ra file Word

## Context
- **Yêu cầu:** Thêm tính năng tạo biên bản kiểm kê Word (.docx) tại trang manager-device.html
- **Mẫu biên bản:** "Biên bản về việc kiểm kê thiết bị dạy học" (theo hình ảnh mẫu)
- **Branch:** `feature/v1.0.0-device-word-export`
- **Version:** v1.0.0 (MINOR - tính năng mới)

## Phân tích mẫu biên bản (từ hình ảnh)

### Bố cục Word:
1. **Header:** SỞ GD&ĐT QUẢNG TRỊ / TRƯỜNG THPT CHẾ LAN VIÊN (trái) | CỘNG HÒA XHCN VN... (phải)
2. **Tiêu đề:** BIÊN BẢN - Về việc kiểm kê thiết bị dạy học
3. **Phần mở đầu:** Căn cứ, thời gian, địa điểm kiểm kê
4. **Thành phần kiểm kê:** Danh sách 10 người (hardcode hoặc config)
5. **Bảng thiết bị theo từng MÔN HỌC:**
   - Heading: "I. MÔN TOÁN", "II. MÔN VẬT LÝ", ...
   - Bảng: STT | Chủ đề dạy học | Tên thiết bị | Đơn vị tính | Tổng số | Hỏng
   - Nhóm con in đậm: "THIẾT BỊ DÙNG CHUNG", "THIẾT BỊ THEO CÁC CHỦ ĐỀ", sub-categories (MÔ HÌNH, HÌNH HỌC VÀ ĐO LƯỜNG, ...)

### Mapping dữ liệu Firestore → Biên bản:
- **Môn học (subject):** Lấy từ `subjects` field của top-level category → tạo heading "I. MÔN ..."
- **Category (type=category):** → Dòng in đậm (nhóm con)
- **Device (type=device):** → Dòng dữ liệu: topic, name (+ description), unit, quantity, broken

## Các file cần thay đổi

| # | File | Thay đổi |
|---|------|----------|
| 1 | `public/manager-device.html` | Thêm nút + modal preview |
| 2 | `public/js/manager-device.js` | Thêm hàm buildInventoryHTML() + preview + export |
| 3 | `public/css/manager-device.css` | Style cho modal preview |

## Nguyên tắc: Single-source HTML

**Preview và Word PHẢI khớp 100%** → dùng cách tiếp cận **single-source**:
1. Hàm `buildInventoryHTML()` sinh ra **1 chuỗi HTML duy nhất** (inline CSS)
2. **Preview:** Đưa HTML đó vào modal để hiển thị
3. **Xuất Word:** Lấy đúng HTML đó, wrap thành Blob `application/msword` → tải .doc
   - MS Word mở được file HTML có đuôi .doc (đây là cách manager-report.js đang dùng)
   - Không cần thư viện `docx` riêng → đảm bảo khớp 100%

## Chi tiết triển khai

### Step 1: Thêm nút + modal preview vào HTML
- Thêm nút "Xuất biên bản kiểm kê" vào toolbar
- Thêm modal preview full-screen chứa container hiển thị biên bản
- Footer modal: 2 nút "Tải file Word" + "Đóng"

### Step 2: Implement hàm buildInventoryHTML()
- Sinh **1 chuỗi HTML hoàn chỉnh** với inline CSS (font Times New Roman, size 13pt, border table...)
- **Logic xử lý dữ liệu:**
  1. Dùng `allItemsCache` (đã có sẵn)
  2. Tìm tất cả top-level categories (parentId = null, type = category)
  3. Với mỗi subject (từ allSubjectsCache), tìm các top-level categories có chứa subject đó
  4. Lấy đệ quy tất cả children (categories + devices) của từng top-level category
  5. Render HTML theo cấu trúc: Subject heading → Category rows (bold) → Device rows

- **Nội dung HTML:**
  ```
  Header: 2 cột (cơ quan trái, quốc hiệu phải)
  Title: BIÊN BẢN (bold, center)
  Subtitle: Về việc kiểm kê thiết bị dạy học
  Body: Các đoạn mở đầu (căn cứ, thời gian, địa điểm, thành phần)

  Lặp cho mỗi Subject:
    Heading: "I. MÔN [TÊN MÔN]" (bold, uppercase)
    Table:
      Header: STT | Chủ đề dạy học | Tên thiết bị | Đơn vị tính | Tổng số | Hỏng
      Category rows: merge cells, bold text
      Device rows: data cells
  ```

### Step 3: Implement preview + xuất Word
- **Preview:** Click nút → gọi `buildInventoryHTML()` → đưa vào modal container → mở modal
- **Xuất Word:** Click "Tải file Word" → lấy HTML từ container → wrap thành Blob → tải file `.doc`
  ```js
  const blob = new Blob(['\ufeff' + html], { type: 'application/msword' });
  // saveAs(blob, 'bien-ban-kiem-ke.doc')
  ```

### Step 4: Xử lý các trường hợp đặc biệt
- Category có nhiều subjects → xuất hiện ở nhiều phần (mỗi subject 1 lần)
- Category lồng nhiều cấp → flatten theo thứ tự order, category con in đậm
- Device không có topic → để trống cột "Chủ đề"
- Đánh số La Mã cho subjects (I, II, III...), số thường cho devices trong bảng

## Tracking

| Step | Mô tả | Status |
|------|--------|--------|
| 1 | Thêm nút + modal preview vào HTML + CSS | ✅ done |
| 2 | Implement buildInventoryHTML() (single-source) | ✅ done |
| 3 | Implement preview + xuất Word (.doc) | ✅ done |
| 4 | Xử lý edge cases + test | ✅ done |

## Verification
- Click nút "Xuất biên bản kiểm kê" → mở modal preview
- Preview hiển thị đúng bố cục biên bản (header, tiêu đề, bảng theo môn)
- Click "Tải file Word" → tải file .docx
- Mở file Word → kiểm tra bố cục khớp với preview và mẫu hình ảnh
- Kiểm tra dữ liệu thiết bị đúng theo từng môn học
- Kiểm tra categories hiển thị đúng dạng nhóm in đậm
- Kiểm tra số liệu Tổng số, Hỏng chính xác
